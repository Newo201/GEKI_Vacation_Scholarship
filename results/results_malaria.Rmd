---
title: "Generalised Ensemble Kalman Inversion - Misspecified Noise"
author: "Owen Jackson"
date: "2025-01-15"
output: github_document
---

# Results for Malaria Model

## Imports

### External Functions

```{r}
pacman::p_load(pacman, testthat, deSolve, rootSolve, MASS, mvtnorm, extraDistr, 
               purrr, glue, logitnorm)
```

### Algorithms

```{r}
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/eki.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/eki_known_noise.R')
```

### Models

```{r}
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/models/eki_malaria.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/models/eki_malaria_known_var.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/models/eki_malaria_known_d_in.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/models/eki_malaria_d_in_only.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/models/eki_normal_known_var.R')
```

### **Sampling and PDFS**

```{r}
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/pdfs/pdfs_normal.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/samples/samples_normal.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/pdfs/pdfs_malaria.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/samples/samples_malaria.R')
```

### Utils

```{r}
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/utils/eki_helper.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/src/utils/tempering.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/results/plots_normal.R')
source('C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/results/plots_malaria.R')
```

```{r}
adaptive = TRUE
```

## Malaria Transmission Model

```{r}
# data_path = "C:/Users/owenj/OneDrive/Uni/Vacation Scholarship/GEKI_Vacation_Scholarship/data/Malariah_data.rds"
# true_sample = log(readRDS(data_path))
# true_data = c(true_sample, sd(true_sample))

num_particles <- 400

prior_params <- list(din.sd = 2,
                     phi.mean = 0, phi.sd = 1,
                     eta0.mean = 0, eta0.sd = 1, 
                     sigma.mean = 0, sigma.sd = 1)

true_params <- list(sigma = 0.5, phi = 0.25, eta0 = 0.11, d_in = 0.5)
true_unconstrained_params = unconstrain_malaria_params(true_params)
true_sample <- likelihood_malaria(true_unconstrained_params)
true_data <- c(true_sample, sd(true_sample))
```

### Four Unknown Parameters

Initially, we tried looking at $\theta = (d_{in}, \phi, \eta_0, \sigma)$ as our unknown parameters.

```{r}
eki_result <- eki_malaria(num_particles, true_data, 
                          true_unconstrained_params, prior_params, 
                          adaptive = adaptive)
plot_eki_malaria(eki_result, true_params, prior_params)
# plot_eki_posterior_predictive(eki_result, true_data, true_unconstrained_params)
```

While the posterior predictive fits the true data well, the GEKI algorithm has a difficult time identifying the true $d_{in}$ and $\eta_0$. In that sense, we get values for $d_{in}$ which don't make sense in the context of the model.

```{r}
d_in_particles <- exp(eki_result$particles[, 1]) + 0.16
eta0_particles <- plogis(eki_result$particles[, 3])
plot(eta0_particles, d_in_particles)
model <- lm(d_in_particles ~ eta0_particles)
abline(model, col = 'red')
cor(d_in_particles, eta0_particles)
```

Upon closer inspection we see a strong positive correlation between the $d_{in}$ and $\eta_0$ particles. Essentially the higher values offset each other, producing predictions which fit the true data. The reason this has more of an effect on $d_{in}$ is most likely a combination of the prior distributions and because $d_{in}$ is more sensitive to changes in $\eta_0$.

It is worth noting that this co-identifiability issue is not unique to EKI; similar results were found when running SMC on the same model.

### Three Unknown Parameters

Based on the above findings, it was decided to instead look at $\theta = (\eta_0, \phi, \sigma^2)$.

```{r}
# GEKI
eki_result <- eki_malaria_known_d_in(num_particles, true_data, 
                                    true_unconstrained_params, prior_params, 
                                    adaptive = adaptive)
plot_eki_malaria_known_d_in(eki_result, true_params, prior_params)
# plot_eki_posterior_predictive_known_d_in(eki_result, true_data, true_unconstrained_params)
```

```{r}
plot_eki_malaria_known_d_in(eki_result, true_params, prior_params)
```
